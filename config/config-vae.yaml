# ==================== CONFIG VAE AMÉLIORÉ ====================
# Date: 5 janvier 2026
# Améliorations: Anti-overfitting, régularisation accrue, augmentations renforcées

# === RESUME TRAINING (Optionnel) ===
# Chemin vers un checkpoint (.pt) pour reprendre l'entraînement
resume: "logs/VAE_17/best_model.pt" 

data:
  data_dir: "/usr/users/sdim/sdim_31/UX-Key-PFE/vae_dataset_scaled"
  archetypes_dir: "/usr/users/sdim/sdim_31/UX-Key-PFE/archetypes_png_scaled"  # Wireframes étiquetés pour métriques latentes
  batch_size: 16                    # Requis pour tailles variables
  num_workers: 8                 # Parallélisation I/O
  valid_ratio: 0.2               # 80/20 train/valid split
  seed: 42                       # Reproductibilité
  
  # Gestion mémoire
  max_height: 3000               # Limite hauteur (crop si dépasse)
  
  # === DENOISING (Augmenté pour robustesse) ===
  noise_level: 0.20              # était: 0.15 → +33% bruit gaussien
  
  # === AUGMENTATIONS (Renforcées contre overfitting) ===
  augment: true
  sp_prob: 0.04                  # était: 0.02 → x2 salt-and-pepper
  random_erasing_prob: 0.35      # était: 0.2 → +75% masking
  perspective_p: 0.3             # Perspective transform (inchangé)
  perspective_distortion_scale: 0.12  # était: 0.08 → +50% distortion
  
  # === NOUVELLES AUGMENTATIONS ===
  rotation_degrees: 5            # Rotation légère ±5°
  brightness_jitter: 0.1         # Variation luminosité ±10%
  contrast_jitter: 0.1           # Variation contraste ±10%

# ==================== MODEL ====================
model:
  name: "vae"
  class: "VAE"                   # Doit correspondre à vae_models.py
  latent_dim: 128                # Dimension espace latent
  input_channels: 1              # Grayscale
  dropout_p: 0.15                # Dropout dans decoder
  use_skip_connections: true     # Skip connections U-Net (préserve détails)

# ==================== LOSS (Optimisé pour espace latent STRUCTURÉ) ====================
# Options: 'l1', 'mse', 'perceptual'
# 'perceptual' = L1 + SSIM + Gradient + Multi-scale (recommandé pour wireframes)
loss:
  name: "l1"             # NOUVEAU: Loss perceptuelle pour structure
  beta_kld: 1                    # β-VAE: balance reconstruction vs régularisation latente
  warmup_epochs: 0               # KLD warmup progressif (évite posterior collapse)
  
  # Poids des composantes (uniquement pour name='perceptual')
  lambda_l1: 1.0                 # Précision pixel (reconstruction fidèle)
  lambda_ssim: 0.5               # Similarité structurelle (layouts, blocs)
  lambda_gradient: 0.1           # Préservation des bords (lignes, contours)
  lambda_multiscale: 0.2         # Hiérarchie spatiale (global + détails)
  use_multiscale: true           # Activer loss multi-échelle

# ==================== OPTIMIZER (Démarrage plus conservateur) ====================
optim:
  algo: "AdamW"
  params:
    lr: 0.0003                   # Learning rate initial
    weight_decay: 0.0001         # Régularisation L2
  
  # === SCHEDULER (CosineAnnealingWarmRestarts pour cycles d'apprentissage) ===
  scheduler:
    name: "CosineAnnealingWarmRestarts"
    params:
      T_0: 100                   # Redémarre tous les 100 epochs
      T_mult: 2                  # Double la période après chaque restart
      eta_min: 0.000003          # LR minimum (plancher)
      verbose: true

# ==================== OPTIMIZATION ====================
optimization:
  lr: 0.0003
  weight_decay: 0.0001
  accumulation_steps: 4          # Gradient accumulation
  mixed_precision: true          # AMP pour vitesse + mémoire
  
  # === MIXUP / CUTMIX (Améliore généralisation) ===
  use_mixup: true
  mixup_alpha: 0.2
  use_cutmix: true
  cutmix_alpha: 1.0
  mix_prob: 0.3                  # Probabilité d'appliquer mix (30% des batches)

# ==================== LOGGING ====================
logging:
  logdir: "./logs"
  tensorboard: true
  log_loss_components: true      # Log SSIM/gradient/KLD séparément
  save_reconstructions_every: 5
  latent_visualization:
    frequency: 20                # t-SNE tous les 20 epochs
    max_samples: 500
    interpolation_method: "slerp"  # NOUVEAU: Méthode d'interpolation (slerp/lerp)
    num_interpolation_steps: 10    # NOUVEAU: Nombre de frames d'interpolation
  # wandb:
  #   project: "ux-vae-improved"
  #   entity: "your-team"

# ==================== TRAINING ====================
nepochs: 1000

# ==================== EARLY STOPPING ====================
early_stopping:
  enabled: true
  monitor: "test_SSIM"           # Métrique surveillée (ou "test_ELBO")
  mode: "max"                    # max pour SSIM, min pour ELBO
  patience: 20                   # Arrête si pas d'amélioration 20 epochs
  min_delta: 0.0001              # Amélioration minimale considérée
